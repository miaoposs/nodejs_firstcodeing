var request = require('request');
var fs = require('fs');

var spus = [
  1039056,
  1006007,
  1006010,
  1006025,
  1006056,
  1006057,
  1006058,
  1006059,
  1006060,
  1006062,
  1006063,
  1006065,
  1006067,
  1009013,
  1009024,
  1015007,
  1017000,
  1017004,
  1017005,
  1017006,
  1017007,
  1017008,
  1018008,
  1018009,
  1019000,
  1019001,
  1020000,
  1021004,
  1021010,
  1021022,
  1021023,
  1021024,
  1021025,
  1022000,
  1022001,
  1023003,
  1023004,
  1023006,
  1023011,
  1023012,
  1023018,
  1023021,
  1023022,
  1023023,
  1023032,
  1023034,
  1023036,
  1023037,
  1023038,
  1023040,
  1024003,
  1025005,
  1026000,
  1027000,
  1028003,
  1028004,
  1028007,
  1028008,
  1028009,
  1028010,
  1029001,
  1029003,
  1030001,
  1030002,
  1030005,
  1030020,
  1031005,
  1031006,
  1031007,
  1031008,
  1031009,
  1031011,
  1031013,
  1031014,
  1033000,
  1035006,
  1036009,
  1036010,
  1036013,
  1036016,
  1037003,
  1037005,
  1037010,
  1037011,
  1038002,
  1038004,
  1039006,
  1039018,
  1039020,
  1039037,
  1039051,
  1042002,
  1042004,
  1043001,
  1043005,
  1043007,
  1043010,
  1043011,
  1043012,
  1043013,
  1043018,
  1046010,
  1046012,
  1046014,
  1046016,
  1046027,
  1046040,
  1046044,
  1046047,
  1046049,
  1048002,
  1048005,
  1048009,
  1048010,
  1050001,
  1050006,
  1050008,
  1051000,
  1051001,
  1051002,
  1051003,
  1051004,
  1052004,
  1052005,
  1055001,
  1055005,
  1055012,
  1055015,
  1055016,
  1055017,
  1055018,
  1056005,
  1057000,
  1057001,
  1057002,
  1057012,
  1057013,
  1057016,
  1057017,
  1057024,
  1057036,
  1057037,
  1059007,
  1059010,
  1060002,
  1060003,
  1060007,
  1060011,
  1061000,
  1061001,
  1061002,
  1062004,
  1062026,
  1062028,
  1062029,
  1062033,
  1062037,
  1064009,
  1064021,
  1064022,
  1065001,
  1065003,
  1066020,
  1066021,
  1068000,
  1068002,
  1068003,
  1068004,
  1068006,
  1068007,
  1068008,
  1068010,
  1068011,
  1070005,
  1071009,
  1073008,
  1075000,
  1075001,
  1075002,
  1075003,
  1075024,
  1076003,
  1076004,
  1076005,
  1077003,
  1079002,
  1079004,
  1079009,
  1079010,
  1079011,
  1079012,
  1079013,
  1081000,
  1082000,
  1083000,
  1083001,
  1083003,
  1084001,
  1085000,
  1085013,
  1085015,
  1085016,
  1085017,
  1086015,
  1086045,
  1088011,
  1090004,
  1090007,
  1090008,
  1091000,
  1091002,
  1091003,
  1092020,
  1092041,
  1093010,
  1093012,
  1093013,
  1096000,
  1096001,
  1096003,
  1096004,
  1096005,
  1097005,
  1097011,
  1099002,
  1100001,
  1100002,
  1100005,
  1100010,
  1102000,
  1102005,
  1102009,
  1105003,
  1105004,
  1106000,
  1108002,
  1108003,
  1108006,
  1108009,
  1108010,
  1108011,
  1108012,
  1108021,
  1108035,
  1109004,
  1109005,
  1109009,
  1109013,
  1109014,
  1109019,
  1109020,
  1109022,
  1109024,
  1109031,
  1110000,
  1110002,
  1110003,
  1110004,
  1110007,
  1110008,
  1111004,
  1111011,
  1111012,
  1111015,
  1111016,
  1111017,
  1111018,
  1111022,
  1113000,
  1113001,
  1113002,
  1113007,
  1113008,
  1113010,
  1113011,
  1113012,
  1113013,
  1113014,
  1115028,
  1115031,
  1115033,
  1115034,
  1115035,
  1115038,
  1115041,
  1115044,
  1115046,
];

//获取商品评论
var getComments = function(itemId){
  var page = 0;
  var total_page = 0;
  var total = 0;

  do
  {
    page++;
    var garbUrl = "http://you.163.com/xhr/comment/listByItem.json?csrf_token=b339a6c26dda3f6d7aae0ae2dc585a28&itemId=" + itemId + '&size=30&page=' + page;

    //发起网络请求
    request(garbUrl, function(error, response, body){
      //网络请求出错
      if(error != null){
        console.log("请求错误:" + error);
        return;
      }

      //response有误
      if(response.statusCode != 200){
        console.log("response错误:" + response.statusCode);
      }

      body = JSON.parse(body);
      var comments  = body['data']['result'];
      if(page == 1){
        total_page = body['data']['pagination']['totalPage'];
        total = body['data']['pagination']['total'];
      }

      console.log("======本次拉取spu为" + spu + "的商品，总评论条数为" + total + ", 总页数为" + total_page + ", 当前进行到第" + page + "页======");


      for(var index in comments){
        comments[index]['spu'] = itemId;

        options = {
          flag:'a'
        };
        fs.writeFile('comments.json', JSON.stringify(comments[index]) + '\r\n', options, function(error){
          if(error != null){
            console.log(error);
          }
        });
      }
    });
  } 
  while (page <= total_page) ; 
};


//执行主体
for(var index in spus){
  var spu = spus[index];
  console.log("======准备拉取" + spu[index] + "的商品评论======");
  getComments(spu);
  return;
}

console.log("本次脚本耗时" + process.uptime());